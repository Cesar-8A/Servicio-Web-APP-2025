{% extends "home.html" %}

{% block content %}
    <div class="container mt-4 text-center">
        {% if success == 0 %}
            <h1 class="text-light">Carga primero una imagen</h1>
        {% else %}
            <div class="card bg-dark text-light shadow-lg p-4 border-0 rounded-3">
                <h1 class="mb-3">Visualización DICOM</h1>
                <p class="lead">Renderizado de la imagen cargada.</p>

                <!-- Contenedor del visor con mejor presentación -->
                <div class="d-flex justify-content-center">
                    <div class="border border-secondary rounded-3 shadow-lg p-3 bg-black">
                        <iframe src="http://127.0.0.1:5010/panel" id="DicomRender" width="400" height="500"
                            class="border-0 rounded-3">
                        </iframe>
                    </div>
                </div>

                <!-- Subir RT Struct (NRRD) -->
                <div class="mt-4">
                    <h2 class="text-light">Subir RT Struct (NRRD)</h2>
                    <form action="/upload_RT" method="post" enctype="multipart/form-data" class="mt-3">
                        <div class="input-group w-50 mx-auto">
                            <input type="file" name="file" accept=".nrrd" class="form-control bg-secondary text-light border-0 shadow-sm">
                            <button type="submit" class="btn btn-success"><i class="bi bi-upload"></i> Subir</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Codigo para cargar visualizacion 2D en 3 planos -->
            <div>
                <h3>Vista Axial</h3>
                <input type="range" id="slider_axial" min="0" max="{{ max_value_axial }}" step="1" value="{{max_value_axial//2}}" />
                <input type="number" id="number_axial" min="0" max="{{ max_value_axial }}" step="1" value="{{max_value_axial//2}}" />
                <img id="image_axial" src="/image/axial/0" alt="Vista Axial" width="500" />
              </div>
            
              <div>
                <h3>Vista Sagital</h3>
                <input type="range" id="slider_sagital" min="0" max="{{ max_value_sagital }}" step="1" value="{{max_value_sagital//2}}" />
                <input type="number" id="number_sagital" min="0" max="{{ max_value_sagital }}" step="1" value="{{max_value_sagital//2}}" />
                <img id="image_sagital" src="/image/sagital/0" alt="Vista Sagital" width="500" />
              </div>
            
              <div>
                <h3>Vista Coronal</h3>
                <input type="range" id="slider_coronal" min="0" max="{{ max_value_coronal }}" step="1" value="{{max_value_coronal//2}}" />
                <input type="number" id="number_coronal" min="0" max="{{ max_value_coronal }}" step="1" value="{{max_value_coronal//2}}" />
                <img id="image_coronal" src="/image/coronal/0" alt="Vista Coronal" width="500" />
              </div>
              
              <script>
                function setupSlider(view) {
                  const slider = document.getElementById(`slider_${view}`);
                  const number = document.getElementById(`number_${view}`);
                  const image = document.getElementById(`image_${view}`);
            
                  function updateImage(layer) {
                    image.src = `/image/${view}/${layer}?t=${new Date().getTime()}`;
                  }
            
                  slider.addEventListener('input', () => {
                    number.value = slider.value;
                    updateImage(slider.value);
                  });
            
                  number.addEventListener('input', () => {
                    let val = Number(number.value);
                    if (val < slider.min) val = slider.min;
                    if (val > slider.max) val = slider.max;
                    slider.value = val;
                    updateImage(val);
                  });
                }
            
                setupSlider('axial');
                setupSlider('sagital');
                setupSlider('coronal');
              </script>
    
        {% endif %}
    </div>

    <script>
        document.querySelector("form").addEventListener("submit", function(event) {
            event.preventDefault();  
            let formData = new FormData(this);

            fetch("/upload_RT", {
                method: "POST",
                body: formData
            });

            alert("Archivo cargado correctamente.");
        });
    </script>
{% endblock %}
